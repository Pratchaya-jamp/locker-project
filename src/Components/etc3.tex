// src/components/QrScanner.js

import React, { useState, useEffect } from 'react';
import QrReader from 'react-qr-reader'; 
import { db, ref, set, update, serverTimestamp, onValue } from '../Firebase/Firebase'; 

function QrScanner({ lockerId, actionType, onActionComplete }) {
  const [isScanning, setIsScanning] = useState(false); 
  const [scanResult, setScanResult] = useState(null);
  const [isSaving, setIsSaving] = useState(false);
  const [lockerData, setLockerData] = useState({});
  const [stopScanner, setStopScanner] = useState(false); 

  // --- Listener ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Locker ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ---
  useEffect(() => {
      if (!lockerId) return;
      const dbRef = ref(db, `lockers/${lockerId}`);
      const unsubscribe = onValue(dbRef, (snapshot) => {
          setLockerData(snapshot.val() || {});
      });
      return () => unsubscribe();
  }, [lockerId]);

  // --- Effect ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏∏‡∏î‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ---
  useEffect(() => {
      if (stopScanner) {
          const timer = setTimeout(() => {
              setStopScanner(false);
          }, 500); 
          return () => clearTimeout(timer);
      }
  }, [stopScanner]);

  const handleError = (err) => {
    console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á:", err);
  };

  const handleValidationAndSave = async (ownerId) => {
      setIsSaving(true);

      try {
          // ‚≠ê FIX: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÇ‡∏î‡∏¢‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• = 'AVAILABLE' ‡πÄ‡∏™‡∏°‡∏≠
          const currentStatus = lockerData.status || 'AVAILABLE';

          if (actionType === 'DEPOSIT') {
              // üî¥ ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤ (Deposit)
              if (currentStatus === 'AVAILABLE') {
                  const updates = {
                      status: 'OCCUPIED',
                      ownerId: ownerId, 
                      deposit_time: serverTimestamp(),
                      // ‚≠ê NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Relay 1 = ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π
                      relay_command: 1 
                  };
                  await update(ref(db, `lockers/${lockerId}`), updates);
                  alert(`‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î Locker ${lockerId} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ù‡∏≤‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤`);
                  onActionComplete(lockerId, true); 
              } else {
                 // ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô OCCUPIED (‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á)
                 alert(`‚ùå ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ${lockerId} ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á! (‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)`);
                 onActionComplete(lockerId, false, true); // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Locker
              }
          } else if (actionType === 'WITHDRAW') {
              // üü¢ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å (Withdrawal)
              if (currentStatus === 'OCCUPIED' && lockerData.ownerId === ownerId) {
                  const updates = {
                      status: 'AVAILABLE',
                      ownerId: null, // ‡∏•‡πâ‡∏≤‡∏á ownerId
                      withdrawal_time: serverTimestamp(),
                      // ‚≠ê NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Relay 1 = ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡∏ï‡∏π
                      relay_command: 1
                  };
                  await update(ref(db, `lockers/${lockerId}`), updates);
                  alert(`‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î Locker ${lockerId} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏≠‡∏≠‡∏Å`);
                  onActionComplete(lockerId, true); 
              } else {
                  alert('‚ùå ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå');
                  onActionComplete(lockerId, false); 
              }
          }
      } catch (error) {
          console.error("Firebase Update Error:", error);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå)");
          onActionComplete(lockerId, false);
      } finally {
          setIsSaving(false);
      }
  };

  const handleScan = (data) => {
    if (data) {
      setScanResult(data);
      handleValidationAndSave(data); 

      setStopScanner(true); 
      setIsScanning(false); 
    }
  };

  // --- FIX: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏î‡πâ‡∏ß‡∏¢ setTimeout (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Play Interruption) ---
  const startScanning = () => {
    setScanResult(null); 
    setTimeout(() => {
        setIsScanning(true);
    }, 1); 
  };

  return (
    <div style={{ padding: '20px', textAlign: 'center' }}>
      <h2>2. ‡∏™‡πÅ‡∏Å‡∏ô QR Code (LINE ID)</h2>
      <h3>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: **{actionType}** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Locker **{lockerId}**</h3>

      <button onClick={startScanning} disabled={isScanning || isSaving || stopScanner}
        style={{ padding: '10px 20px', fontSize: '16px', cursor: 'pointer', margin: '20px 0' }}
      >
        {isScanning ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô...' : isSaving ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô QR Code'}
      </button>

      {isScanning && !stopScanner && (
        <div style={{ width: '300px', margin: '20px auto', border: '2px solid #61dafb' }}>
          <QrReader key="scanner-active" delay={100} onError={handleError} onScan={handleScan}
            style={{ width: '100%' }} constraints={{ facingMode: 'environment' }} 
          />
        </div>
      )}
      
      <p style={{ marginTop: '20px' }}>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: **{isSaving ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...' : scanResult ? '‡∏™‡πÅ‡∏Å‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô'}**</p>
      
      {scanResult && <p>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ: {scanResult}</p>}
      
      <button onClick={() => onActionComplete(lockerId, false, true)} style={{ marginTop: '20px' }}>
          ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå
      </button>
    </div>
  );
}

export default QrScanner;